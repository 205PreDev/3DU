# CLAUDE.md

Claude Code 작업 지침 파일

## 프로젝트 개요

**교육용 3D 물리 시뮬레이터** - 물리 법칙을 3D 시각화로 학습하는 웹 플랫폼
현재 모듈: 야구 투구 시뮬레이터 (중력, 항력, 마그누스 효과)

## 빠른 시작

```bash
# 프론트엔드
npm install && npm run dev

# 백엔드
cd backend && npm install && npm run dev
```

## 아키텍처

- **3-Tier**: React/Three.js | Node.js/Express | PostgreSQL
- **모듈식 설계**: 시나리오 독립 구조 (`src/scenarios/{name}/`)
- **물리 계산**: 클라이언트 사이드
- **공통 코어**: `src/core/` (physics, renderer, ui)

## 주요 문서

| 문서 | 경로 | 용도 |
|------|------|------|
| 작업 목록 | `archive/작업목록.md` | 진행 상황 및 할 일 |
| 설계 명세서 v2 | `docs/프로젝트 설계 명세서.md` | 전체 설계 (최신: 2025-10-26) |
| 요구사항 | `docs/요구사항명세서_문서용.txt` | 요구사항 명세 |

## 🚨 긴급 작업 (우선순위 최상)

**다음 세션에서 즉시 처리해야 할 사항**: 없음

---

## 완료된 작업 (2025-10-27)

### ✅ 카메라 떨림 현상 해결 (최신)
- **문제**: 고정된 카메라 시점에서 화면이 떨리는 현상
- **원인**:
  - 매 프레임마다 lerp 적용으로 부동소수점 오차 누적
  - OrbitControls와 CameraController의 동시 제어 충돌
- **해결**:
  - 목표 위치 도달 시 lerp 중단 (거리 < 0.001m)
  - OrbitControls를 `free` 모드에서만 조건부 활성화
  - 고정 시점에서 lookAt 동기화
- **파일**: `src/core/renderer/CameraController.tsx`, `src/core/renderer/Scene3D.tsx`, `src/scenarios/pitch/PitchSimulator.tsx`

### ✅ 측면 시점 개선 (최신)
- 투수-포수 선과 완전히 수직인 시점 구현
- position: [15, 2.5, -9.22], target: [0, 1.5, -9.22]
- z 좌표를 정확히 중간 지점으로 통일
- **파일**: `src/core/renderer/CameraController.tsx`

### ✅ X축 회전 시 공 궤적 문제 해결 (최신)
- **문제 분석**: 물리 계산은 정상, UI 가이드의 잘못된 설명이 원인
- **해결**:
  - 회전축별 효과 설명 수정 (X축: 낙차, Y축: 백스핀/탑스핀, Z축: 좌우)
  - 예시 프리셋 수정 (슬라이더: spinX → spinZ로 변경)
- **파일**: `src/scenarios/pitch/PitchInputPanel.tsx`

### ✅ 카메라 컨트롤 및 리플레이 기능 구현
- 카메라 프리셋 버튼 UI 구현 (포수 시점 / 측면 / 투수 시점)
- 리플레이 컨트롤 UI 구현 (Play/Pause, 속도 조절, 진행률 슬라이더)
- CameraController 컴포넌트로 카메라 로직 분리
- 시뮬레이션 일시정지/재개 기능 추가

### ✅ 릴리스 포인트 3D 좌표 구현
- `releaseHeight` 제거, `releasePoint: Vector3`로 통합
- X/Y/Z축 릴리스 포인트 입력 UI 구현
- 투구 폼별 예시 가이드 추가 (클릭하여 적용)
  - 오버핸드 우완/좌완
  - 사이드암 우완
  - 언더핸드 우완
  - 좌완 슬라이더
- 마그누스 효과가 극적으로 체감되도록 개선
- 우완/좌완 바깥쪽 릴리스로 실제 야구와 유사한 궤적 구현

### ✅ Phase 1-6: 기본 구현 완료 (2025-10-26)
- UI 모드 통합 (Simple/Advanced → 단일 모드)
- 파라미터 3단 구조 (공 물성 | 투구 조건 | 환경 변수)
- 중력 가변화 (환경 변수로 제어)
- 공기 밀도 자동 계산 (온도/기압/습도 → ρ)
- 에셋 단순화 (교육용 목적 명시)

### ✅ 프리셋 제거 및 직접 입력 UI 전환 (2025-10-26)
- 구종 프리셋 버튼 제거
- 13개 파라미터 직접 입력 UI 구현
- 파라미터 설명 툴팁 추가 (? 아이콘)
- 회전축 라벨 추가 (X/Y/Z)
- 구종별 입력 예시 가이드 버튼
- 스트라이크 존 통과 시점 실시간 판정

### ✅ 3D 렌더링 성능 최적화 (2025-10-26)
- Three.js geometry 폴리곤 수 감소
- 애니메이션 프레임레이트 조정 (50fps → 30fps)
- 그림자 품질 낮추기 (shadow-mapSize: 2048 → 1024)
- TrajectoryLine 포인트 간격 늘리기
- React.memo 적용 (Ball3D, TrajectoryLine)

### ✅ 해결된 이슈: 마그누스 효과 문제
**문제**: X/Z축 회전 시 수평 변화가 거의 체감되지 않음
**원인**: 릴리스 포인트가 정중앙이라 변화량이 밋밋하게 느껴짐 (물리 계산은 정상)
**해결**: 릴리스 포인트 3D 좌표 구현으로 해결 완료 (2025-10-27)

---

## 현재 상태

- **브랜치**: `dev` (현재 작업 중)
- **타입 체크**: ✅ 통과
- **빌드**: 미확인
- **최근 작업**: 카메라 떨림 해결, 측면 시점 개선, X축 회전 문제 해결 (2025-10-27)
- **긴급 작업**: 없음
- **다음 작업**: 사용자 테스트 및 피드백 대기

## 개발 규칙

- **단위**: 미터(m), m/s, 도(°), rpm
- **좌표계**: z축 음수 = 홈플레이트 방향, x축 양수 = 1루 방향
- **UI**: 단일 모드 (모드 토글 없음), **프리셋 없음** (직접 입력만)
- **파라미터**: 3단 구조 (공 물성 / 투구 조건 / 환경 변수)
- **중력**: 환경 변수로 조정 (고정값 아님)
- **에셋**: 단순화 우선 (< 300 폴리곤, 성능 최적화)
- **확장성**: 새 시나리오 추가 ~30분 (모듈식 구조)
- **성능**: 30fps 목표 (9세대 CPU 기준)

## 작업 관리 규칙

### 작업 목록 업데이트 정책
- 작업 완료 시 `archive/작업목록.md`를 업데이트할 것
- 토큰 효율을 위해 키워드 검색으로 작업 항목 찾기 (Grep 사용)
- 업데이트 주기: 3~4개 작업 완료 또는 작업 부문(Phase/섹션) 완료 시
- 매 작업마다 업데이트하지 말 것 (토큰 낭비 방지)

### 작업 결산 시 체크리스트 ✨ NEW
**세션 종료 전 반드시 확인**:

1. **필요한 내용 정리**:
   - [ ] 다음 세션에서 즉시 처리할 긴급 작업 정의
   - [ ] 작업 관련 파일 경로 명시
   - [ ] 예상되는 기술적 이슈 기록

2. **불필요한 내용 제거**:
   - [ ] 완료된 긴급 작업은 "완료된 작업" 섹션으로 이동
   - [ ] 해결된 이슈는 상태 업데이트 후 정리
   - [ ] 오래된 임시 메모/TODO 삭제

3. **커밋 준비**:
   - [ ] 작업 완료 후 커밋 메시지 초안 작성
   - [ ] 주요 변경사항 요약 (3~5줄)
   - [ ] 관련 이슈 번호 기록 (있을 경우)

4. **CLAUDE.md 업데이트**:
   - [ ] "현재 상태" 섹션 최신화
   - [ ] "마지막 업데이트" 날짜 갱신
   - [ ] 긴급 작업 우선순위 재정렬

---

**마지막 업데이트**: 2025-10-27

---

## ⚡ 다음 세션 시작 시 확인 사항

1. **긴급 작업 섹션 확인** - ✅ 모든 긴급 작업 완료
2. **브랜치 확인**: `dev` 브랜치에서 작업
3. **타입 체크**: ✅ 통과 확인 완료
4. **테스트 권장 사항**:
   - 카메라 프리셋 버튼 (포수/투수/측면/추적/자유) 전환 시 떨림 확인
   - 측면 시점에서 투수-포수 선이 수직으로 보이는지 확인
   - Z축 회전으로 슬라이더/커브 궤적 테스트 (좌우 변화 확인)

---
