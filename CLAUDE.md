# CLAUDE.md

Claude Code 작업 지침 파일

## 프로젝트 개요

**교육용 3D 물리 시뮬레이터** - 물리 법칙을 3D 시각화로 학습하는 웹 플랫폼
현재 모듈: 야구 투구 시뮬레이터 (중력, 항력, 마그누스 효과)

## 빠른 시작

```bash
# 프론트엔드
npm install && npm run dev

# 백엔드
cd backend && npm install && npm run dev
```

## 아키텍처

- **3-Tier**: React/Three.js | Node.js/Express | PostgreSQL
- **모듈식 설계**: 시나리오 독립 구조 (`src/scenarios/{name}/`)
- **물리 계산**: 클라이언트 사이드
- **공통 코어**: `src/core/` (physics, renderer, ui)

## 주요 문서

| 문서 | 경로 | 용도 |
|------|------|------|
| 작업 목록 | `archive/작업목록.md` | 진행 상황 및 할 일 |
| 설계 명세서 v2 | `docs/프로젝트 설계 명세서.md` | 전체 설계 (최신: 2025-10-26) |
| 요구사항 | `docs/요구사항명세서_문서용.txt` | 요구사항 명세 |

## 🚨 긴급 작업 (우선순위 최상)

**다음 세션에서 즉시 처리해야 할 사항**: 없음

---

## 📋 예정된 작업 (UI/UX 개선)

### Phase 2: 저장 및 비교 기능 (진행 중)
1. **비교 모드 구현** (설계 명세서 3.10 기준)
   - 2개 시뮬레이션 동시 실행
   - 궤적 오버레이 (파랑/빨강)
   - 환경 변수 옵션: 독립/통일
   - 계측값 표 + 차이값 표시
   - 리플레이 동기화

### Phase 3: 반응형 및 접근성
2. **반응형 레이아웃**
   - 모바일: 하단 시트 UI
   - 태블릿: 자동 접기
   - 데스크톱: 풀 레이아웃

3. **QR 코드 기능**
   - 랜딩 페이지 하단 배치
   - 모바일 접속 편의성 제공

4. **하단 리플레이 컨트롤 크기 동적 조정**
   - `width = 100vw - menuWidth - settingsWidth`
   - 좌측 메뉴 접기/펴기 시 자동 조정

### 보류된 기능
- ❌ 교사-학생 과제 기능 (Phase 4 이후)
- ❌ 학습 진행도 (불필요)
- ❌ 체험하기 버튼 (데모 영상으로 대체)

---

## 완료된 작업 (2025-10-28)

### ✅ 애니메이션 최적화 및 그래픽 설정 기능 구현 (최신)

#### 1. 애니메이션 부드러움 개선
- **문제**: setInterval 사용으로 공이 끊겨 보이는 현상 (20fps, 2포인트 건너뛰기)
- **해결**: requestAnimationFrame으로 전환
  - 브라우저 최적화 60fps 달성
  - 모든 궤적 포인트 표시 (부드러운 애니메이션)
  - 탭 비활성화 시 자동 중단 (배터리 절약)
- **파일**: `src/scenarios/pitch/PitchSimulator.tsx`

#### 2. 그래픽 설정 기능 구현
- **컴포넌트**: `GraphicsSettingsPanel.tsx`, `GraphicsContext.tsx`
- **기능**: 우측 패널 "그래픽" 탭 추가
- **프리셋 가이드라인**:
  - 저사양 (30fps, 안정적)
  - 중간 (45fps, 균형)
  - 고사양 (60fps, 최고 품질)
- **자유 조정 설정**:
  - 목표 FPS (30-60)
  - 픽셀 밀도/DPR (1.0-2.0x) - 가장 큰 성능 영향
  - 공 품질/폴리곤 수 (8-32)
  - 궤적 정밀도 (50-200점)
  - 시야각/FOV (40-75°)
  - 안티앨리어싱 (ON/OFF)
- **실시간 적용**:
  - Scene3D: DPR, FOV, 안티앨리어싱
  - Ball3D: 공 폴리곤 수 (동적 조정)
  - 애니메이션: 목표 FPS에 맞춘 프레임 간격
  - 물리 계산: trajectoryDt로 궤적 정밀도 제어
- **파일**: `src/contexts/GraphicsContext.tsx`, `src/core/ui/GraphicsSettingsPanel.tsx`, `src/core/renderer/Scene3D.tsx`, `src/scenarios/pitch/Ball3D.tsx`

#### 3. 디버그 패널 및 성능 모니터링
- **컴포넌트**: `DebugPanel.tsx`, `PerformanceMetrics` 타입
- **기능**: 우측 패널 "디버그" 탭 추가
- **측정 지표**:
  - 물리 계산 시간 (현재/평균/최대)
  - 렌더링 성능 (FPS, 렌더 시간, 프레임 카운트)
  - 전체 성능 (총 프레임 시간, 궤적 포인트 수)
  - 메모리 사용량 (사용/할당/제한)
  - 성능 평가 (우수/보통/저하)
- **콘솔 출력**: 브라우저 콘솔에 성능 지표 실시간 출력
  - 시뮬레이션 시작 시: 물리 계산 시간, 궤적 포인트, 결과 수치
  - 렌더링 중: 1초마다 FPS 및 렌더 시간 출력
- **파일**: `src/core/ui/DebugPanel.tsx`, `src/contexts/SimulationContext.tsx`, `src/core/renderer/Scene3D.tsx`

#### 4. 성능 분석 결과
- **저사양 설정 실측**:
  - 물리 계산: 1.6-4.7 ms (매우 빠름)
  - 애니메이션 중 렌더링: 9-15 FPS (목표 30fps 미달)
  - 애니메이션 완료 후: 16-17 FPS (개선)
- **병목 지점**: 궤적 라인 업데이트 + 공 이동 렌더링 (105ms/프레임)
- **결론**: 그래픽 설정만으론 부족, 렌더링 로직 최적화 필요 (보류)

#### 5. 버그 수정
- **finalVelocity 타입 오류**: Vector3 객체를 number로 잘못 처리 (콘솔 에러 발생)
- **horizontalMovement NaN**: 계산 오류 (미수정 상태)

---

## 완료된 작업 (2025-10-27)

### ✅ Phase 1 UI 구조 개선 완료

#### 1. 상단 네비게이션 바 구현
- **컴포넌트**: `TopNavigationBar.tsx`
- **기능**:
  - 뒤로가기 버튼 (시나리오 선택 화면으로 이동 예정)
  - 시나리오 이름 표시
  - 도움말 버튼 (모달 연동)
  - 사용자 메뉴 버튼 (향후 확장)
- **스타일**: 48px 높이, 고정 위치, 반응형

#### 2. 우측 패널 탭 구조 구현
- **컴포넌트**: `TabContainer.tsx`
- **탭 구성**: 4개 탭
  1. **파라미터**: 기존 PitchInputPanel 유지
  2. **결과**: CameraPresetButtons + ReplayControls + ResultPanel
  3. **최근 실험**: RecentExperimentsPanel (신규)
  4. **비교**: ComparisonPanel (플레이스홀더)
- **UI**: 탭 전환 애니메이션, 스크롤 영역 분리

#### 3. 도움말 모달 구현
- **컴포넌트**: `HelpModal.tsx`
- **탭 구성**: 3개 탭
  1. **시작하기**: 단계별 가이드 (파라미터 입력 → 실행 → 결과 확인)
  2. **키보드 단축키**:
     - 시뮬레이션: Space, R, Esc
     - 카메라: 1-5 (프리셋 전환)
     - 리플레이: ←→, [], ,.
  3. **FAQ**: 스트라이크 존, 회전축, 환경 변수, 비교 모드
- **기능**: 클릭으로 열기/닫기, 오버레이 배경

#### 4. 최근 실험 기능 구현 (LocalStorage)
- **컴포넌트**: `RecentExperimentsPanel.tsx`, `ExperimentDetailModal.tsx`
- **유틸리티**: `utils/recentExperiments.ts`
- **기능**:
  - 최대 10개 저장 (자동 정리)
  - 실험 저장 (이름 지정 모달)
  - 실험 불러오기 (파라미터 자동 입력) ✅ 버그 수정 완료
  - 실험 삭제 (개별/전체)
  - 실험 정보 표시 (속도, 회전, 스트라이크 판정)
  - **상세 보기 모달**: 파라미터 전체 + 결과 수치 상세 표시
    - 공 물성 (질량, 반지름, 항력계수, 양력계수)
    - 투구 조건 (속도, 각도, 회전 X/Y/Z, 릴리스 포인트)
    - 환경 변수 (중력, 온도, 기압, 습도)
    - 결과 (비행시간, 최고높이, 수평변화, 수직낙차, 최종속도 등)
- **저장 위치**: LocalStorage (키: `recentExperiments`)
- **데이터 구조**: `{ id, name, params, result, createdAt }`
- **버그 수정**: SimulationContext의 setParams 깊은 병합 로직 개선

---

## 완료된 작업 (2025-10-27 이전)

### ✅ 카메라 떨림 현상 해결 (최신)
- **문제**: 고정된 카메라 시점에서 화면이 떨리는 현상
- **원인**:
  - 매 프레임마다 lerp 적용으로 부동소수점 오차 누적
  - OrbitControls와 CameraController의 동시 제어 충돌
- **해결**:
  - 목표 위치 도달 시 lerp 중단 (거리 < 0.001m)
  - OrbitControls를 `free` 모드에서만 조건부 활성화
  - 고정 시점에서 lookAt 동기화
- **파일**: `src/core/renderer/CameraController.tsx`, `src/core/renderer/Scene3D.tsx`, `src/scenarios/pitch/PitchSimulator.tsx`

### ✅ 측면 시점 개선 (최신)
- 투수-포수 선과 완전히 수직인 시점 구현
- position: [15, 2.5, -9.22], target: [0, 1.5, -9.22]
- z 좌표를 정확히 중간 지점으로 통일
- **파일**: `src/core/renderer/CameraController.tsx`

### ✅ X축 회전 시 공 궤적 문제 해결 (최신)
- **문제 분석**: 물리 계산은 정상, UI 가이드의 잘못된 설명이 원인
- **해결**:
  - 회전축별 효과 설명 수정 (X축: 낙차, Y축: 백스핀/탑스핀, Z축: 좌우)
  - 예시 프리셋 수정 (슬라이더: spinX → spinZ로 변경)
- **파일**: `src/scenarios/pitch/PitchInputPanel.tsx`

### ✅ 카메라 컨트롤 및 리플레이 기능 구현
- 카메라 프리셋 버튼 UI 구현 (포수 시점 / 측면 / 투수 시점)
- 리플레이 컨트롤 UI 구현 (Play/Pause, 속도 조절, 진행률 슬라이더)
- CameraController 컴포넌트로 카메라 로직 분리
- 시뮬레이션 일시정지/재개 기능 추가

### ✅ 릴리스 포인트 3D 좌표 구현
- `releaseHeight` 제거, `releasePoint: Vector3`로 통합
- X/Y/Z축 릴리스 포인트 입력 UI 구현
- 투구 폼별 예시 가이드 추가 (클릭하여 적용)
  - 오버핸드 우완/좌완
  - 사이드암 우완
  - 언더핸드 우완
  - 좌완 슬라이더
- 마그누스 효과가 극적으로 체감되도록 개선
- 우완/좌완 바깥쪽 릴리스로 실제 야구와 유사한 궤적 구현

### ✅ Phase 1-6: 기본 구현 완료 (2025-10-26)
- UI 모드 통합 (Simple/Advanced → 단일 모드)
- 파라미터 3단 구조 (공 물성 | 투구 조건 | 환경 변수)
- 중력 가변화 (환경 변수로 제어)
- 공기 밀도 자동 계산 (온도/기압/습도 → ρ)
- 에셋 단순화 (교육용 목적 명시)

### ✅ 프리셋 제거 및 직접 입력 UI 전환 (2025-10-26)
- 구종 프리셋 버튼 제거
- 13개 파라미터 직접 입력 UI 구현
- 파라미터 설명 툴팁 추가 (? 아이콘)
- 회전축 라벨 추가 (X/Y/Z)
- 구종별 입력 예시 가이드 버튼
- 스트라이크 존 통과 시점 실시간 판정

### ✅ 3D 렌더링 성능 최적화 (2025-10-26)
- Three.js geometry 폴리곤 수 감소
- 애니메이션 프레임레이트 조정 (50fps → 30fps)
- 그림자 품질 낮추기 (shadow-mapSize: 2048 → 1024)
- TrajectoryLine 포인트 간격 늘리기
- React.memo 적용 (Ball3D, TrajectoryLine)

### ✅ 해결된 이슈: 마그누스 효과 문제
**문제**: X/Z축 회전 시 수평 변화가 거의 체감되지 않음
**원인**: 릴리스 포인트가 정중앙이라 변화량이 밋밋하게 느껴짐 (물리 계산은 정상)
**해결**: 릴리스 포인트 3D 좌표 구현으로 해결 완료 (2025-10-27)

---

## 현재 상태

- **브랜치**: `dev` (현재 작업 중)
- **타입 체크**: ✅ 통과 (supabase.ts 에러는 기존 이슈)
- **빌드**: 미확인
- **최근 작업**: 애니메이션 최적화 + 그래픽 설정 + 디버그 패널 구현 (2025-10-28)
- **긴급 작업**:
  1. **렌더링 최적화** (최우선) - 애니메이션 중 FPS 9-15 (목표 30)
     - TrajectoryLine 리렌더링 최소화
     - 궤적 포인트 간격 조정 또는 목표 FPS 하향
  2. **버그 수정**:
     - finalVelocity 타입 오류 (Vector3 → number)
     - horizontalMovement NaN 계산 오류
  3. Supabase 데이터베이스 마이그레이션 (LocalStorage → 클라우드)
  4. 파라미터 입력 제한 해제 + 도움말 가이드라인 추가
  5. 키보드 단축키 기능 구현 (Space 외 미구현)
  6. 우측 패널 숨기기 기능 (미구현)
- **다음 작업**: 렌더링 최적화 → 버그 수정 → 비교 모드 구현
- **데이터베이스**: Supabase 프로젝트 연결 (https://poxmraxgryatmjqjzqol.supabase.co)
  - ⚠️ 토큰 인증 이슈 (테이블 조회 불가)
- **성능 현황**:
  - 물리 계산: 1.6-4.7 ms (최적화 완료)
  - 렌더링: 9-15 FPS (최적화 필요)
  - 병목: TrajectoryLine + Ball 애니메이션 (105ms/프레임)

## 개발 규칙

- **단위**: 미터(m), m/s, 도(°), rpm
- **좌표계**: z축 음수 = 홈플레이트 방향, x축 양수 = 1루 방향
- **UI**: 단일 모드 (모드 토글 없음), **프리셋 없음** (직접 입력만)
- **파라미터**: 3단 구조 (공 물성 / 투구 조건 / 환경 변수)
- **중력**: 환경 변수로 조정 (고정값 아님)
- **에셋**: 단순화 우선 (< 300 폴리곤, 성능 최적화)
- **확장성**: 새 시나리오 추가 ~30분 (모듈식 구조)
- **성능**: 30fps 목표 (9세대 CPU 기준)

## 작업 관리 규칙

### 작업 목록 업데이트 정책
- 작업 완료 시 `archive/작업목록.md`를 업데이트할 것
- 토큰 효율을 위한 방법: Grep으로 수정 위치 찾기 → Read로 해당 부분만 읽기 → Edit로 정확히 수정
- 업데이트 주기: 3~4개 작업 완료 또는 작업 부문(Phase/섹션) 완료 시
- 매 작업마다 업데이트하지 말 것 (토큰 낭비 방지)

### 작업 결산 시 체크리스트 ✨ NEW
**세션 종료 전 반드시 확인**:

1. **필요한 내용 정리**:
   - [ ] 다음 세션에서 즉시 처리할 긴급 작업 정의
   - [ ] 작업 관련 파일 경로 명시
   - [ ] 예상되는 기술적 이슈 기록

2. **불필요한 내용 제거**:
   - [ ] 완료된 긴급 작업은 "완료된 작업" 섹션으로 이동
   - [ ] 해결된 이슈는 상태 업데이트 후 정리
   - [ ] 오래된 임시 메모/TODO 삭제

3. **커밋 준비**:
   - [ ] 작업 완료 후 커밋 메시지 초안 작성
   - [ ] 주요 변경사항 요약 (3~5줄)
   - [ ] 관련 이슈 번호 기록 (있을 경우)

4. **CLAUDE.md 업데이트**:
   - [ ] "현재 상태" 섹션 최신화
   - [ ] "마지막 업데이트" 날짜 갱신
   - [ ] 긴급 작업 우선순위 재정렬

---

**마지막 업데이트**: 2025-10-28 23:59

---

## ⚡ 다음 세션 시작 시 확인 사항

1. **긴급 작업 섹션 확인** - ⚠️ 렌더링 최적화 및 버그 수정 필요
2. **브랜치 확인**: `dev` 브랜치에서 작업
3. **타입 체크**: ✅ 통과 확인 완료
4. **우선순위 작업**:
   - **렌더링 최적화**: 애니메이션 중 FPS 9-15 → 30 목표
   - **버그 수정**: finalVelocity, horizontalMovement
5. **테스트 권장 사항**:
   - 그래픽 설정 변경 후 FPS 변화 확인
   - 저사양/중간/고사양 프리셋 테스트
   - 디버그 패널 및 콘솔 출력 확인

---
