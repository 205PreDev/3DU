# CLAUDE.md

Claude Code 작업 지침 파일

## 프로젝트 개요

**교육용 3D 물리 시뮬레이터** - 물리 법칙을 3D 시각화로 학습하는 웹 플랫폼
현재 모듈: 야구 투구 시뮬레이터 (중력, 항력, 마그누스 효과)

## 빠른 시작

```bash
# 프론트엔드
npm install && npm run dev
```

**테스트 계정**: 회원가입 페이지(`/signup`)에서 생성

## 아키텍처

- **3-Tier**: React/Three.js | Node.js/Express | PostgreSQL
- **모듈식 설계**: 시나리오 독립 구조 (`src/scenarios/{name}/`)
- **물리 계산**: 클라이언트 사이드
- **공통 코어**: `src/core/` (physics, renderer, ui)

## 주요 문서

| 문서 | 경로 | 용도 |
|------|------|------|
| 작업 목록 | `archive/작업목록.md` | 진행 상황 및 할 일 |
| 설계 명세서 v2 | `docs/프로젝트 설계 명세서.md` | 전체 설계 (최신: 2025-10-26) |
| 요구사항 | `docs/요구사항명세서_문서용.txt` | 요구사항 명세 |

## 🚨 긴급 작업 (우선순위 최상)

**다음 세션에서 즉시 처리해야 할 사항**:
1. ✅ **타입 체크 실행**: `npx tsc --noEmit` - 성공 (2025-10-31)
2. **회전축 동작 테스트** (중요!):
   - spinY=+5000 → 1루 방향 확인
   - spinY=-5000 → 3루 방향 확인
   - spinX=+2400 → 백스핀 떠오름 확인
   - 릴리스 포인트 X=+0.5, horizontal=0 → 홈플레이트 중심 통과 확인
   - 기존 저장된 실험 데이터는 회전축 의미 변경으로 궤적이 달라질 수 있음
3. **투수 모델 및 스트라이크 존 확인**:
   - 오버핸드/사이드암/언더핸드 폼 변화 테스트
   - 경계 공 스트라이크 판정 테스트

---

## 📋 예정된 작업 (UI/UX 개선)

### Phase 2: 저장 및 비교 기능 ✅ 완료 (2025-10-30)
1. **비교 모드 구현** ✅
   - ✅ 2개 실험 선택 UI (드롭다운)
   - ✅ 궤적 오버레이 (파랑/빨강)
   - ✅ 계측값 표 + 차이값 표시
   - ❌ 환경 변수 옵션: 독립/통일 (보류)
   - ❌ 리플레이 동기화 (보류)

### Phase 3: 반응형 및 접근성
2. **반응형 레이아웃**
   - 모바일: 하단 시트 UI
   - 태블릿: 자동 접기
   - 데스크톱: 풀 레이아웃

3. **QR 코드 기능**
   - 랜딩 페이지 하단 배치
   - 모바일 접속 편의성 제공

4. **하단 리플레이 컨트롤 크기 동적 조정**
   - `width = 100vw - menuWidth - settingsWidth`
   - 좌측 메뉴 접기/펴기 시 자동 조정

### 보류된 기능
- ❌ 교사-학생 과제 기능 (Phase 4 이후)
- ❌ 학습 진행도 (불필요)
- ❌ 체험하기 버튼 (데모 영상으로 대체)

---

## 완료된 작업 (2025-10-31 16:00~18:30)

### ✅ 블렌더 투수 3D 모델 통합 및 애니메이션 시스템 구현 (최신)

#### 1. FBX 모델 로드 및 기본 설정
- **파일 위치**: `public/models/pitcher.fbx` (846KB, 최적화 완료)
- **구현**: `Pitcher3D.tsx` 전면 재작성
  - 기존 코드 기반 투수 모델 제거
  - `FBXLoader` (three-stdlib) 사용
  - 모델 크기: `scale(0.01, 0.01, 0.01)`
  - 모델 회전: `rotation.y = Math.PI` (180도, -Z 방향 바라보기)
  - 그림자: `castShadow`, `receiveShadow` 설정
- **파일**: `src/scenarios/pitch/Pitcher3D.tsx:29-87`

#### 2. 애니메이션 시스템 설계
- **트리거 기반 재생 방식**: `startTrigger` prop (카운터 증가 시 애니메이션 시작)
  - 기존 `isPitching` boolean 방식 제거
  - 중복 실행 문제 완전 해결
- **애니메이션 클립 설정**:
  - `AnimationMixer`, `AnimationAction` 사용
  - `LoopOnce` 모드, `clampWhenFinished = true`
  - 애니메이션 길이: 119프레임 (약 3.97초, 30fps)
- **파일**: `src/scenarios/pitch/Pitcher3D.tsx:90-146`

#### 3. 투구 모션 타이밍 제어
- **대기 자세**: 1프레임 (모든 초기화 시)
  - 페이지 로딩 시: 1프레임 일시정지
  - 애니메이션 종료 후: 1프레임 복귀
- **재생 시작**: 1프레임부터 시작
  - `action.time = 1 / 30` (0.033초)
- **48프레임 릴리스**: 공 생성 및 물리 계산 시작
  - `onReleaseFrame` 콜백 호출
  - `handlePitcherRelease()` → `setShowBall(true)`, `setIsAnimating(true)`
- **119프레임 종료**: 자동으로 1프레임 복귀
  - 시간 기반 종료 감지: `currentTime >= duration - 0.01`
- **파일**: `src/scenarios/pitch/Pitcher3D.tsx:67-71, 126-138`

#### 4. PitchSimulator 연동
- **상태 변경**:
  - `pitcherAnimating` (boolean) → `pitcherStartTrigger` (number)
  - `hasStartedAnimationRef` 플래그 제거
- **시뮬레이션 시작 로직**:
  ```tsx
  setPitcherStartTrigger(prev => prev + 1) // 트리거 증가
  ```
- **공 표시 제어**: `showBall` state
  - 48프레임 전: 숨김
  - 48프레임 후: 표시
- **파일**: `src/scenarios/pitch/PitchSimulator.tsx:50-68, 340-351`

#### 5. 조명 개선
- **DirectionalLight 추가**:
  - 위치: `[0, 30, -5]` (수직 높이 2배 상승)
  - 강도: `1.2`
  - 그림자 맵: `1024x1024`
- **파일**: `src/core/renderer/Scene3D.tsx:83-89`

#### 6. 콘솔 로그 정리
- 투수 애니메이션 관련 디버그 로그 모두 제거
- 로딩 진행률 로그만 유지
- **파일**: `Pitcher3D.tsx`, `PitchSimulator.tsx`

---

### 🎬 최종 동작 흐름

```
1. 페이지 로딩
   ↓
2. FBX 모델 로드 (846KB)
   ↓
3. 1프레임 대기 자세 (일시정지)
   ↓
4. 사용자가 파라미터 입력 후 [시뮬레이션 시작] 버튼 클릭
   ↓
5. pitcherStartTrigger 증가 (카운터 +1)
   ↓
6. 1프레임부터 애니메이션 재생 시작
   ↓
7. 48프레임 도달
   → onReleaseFrame() 콜백 호출
   → 공 생성 (showBall=true)
   → 공 물리 계산 및 비행 시작
   ↓
8. 투수 모션 끝까지 재생 (119프레임)
   ↓
9. 자동으로 1프레임 대기 자세로 복귀
   ↓
10. 다음 시뮬레이션 준비 완료

⚡ 모션 재생 중 [시뮬레이션 시작] 버튼 재클릭 시:
   → startTrigger 증가
   → 강제로 1프레임부터 모션 재시작
```

---

### 📝 주요 개선 사항

1. **모델 품질**: 코드 생성 모델 → 블렌더 전문 3D 모델 (846KB)
2. **애니메이션 정확도**: 프레임 단위 제어 (30fps 기준)
3. **타이밍 동기화**: 48프레임 릴리스 시점에 정확히 공 생성
4. **중복 실행 방지**: 트리거 기반 방식으로 깔끔하게 해결
5. **대기 자세 통일**: 모든 초기화 시 1프레임 사용

---

### 🐛 해결된 문제

1. **모션 중복 실행**: `isPitching` 의존성 문제 → `startTrigger` 방식으로 해결
2. **모션 종료 감지 실패**: `action.paused` 체크 → 시간 기반 체크 (`currentTime >= duration`)
3. **대기 자세 불일치**: 0프레임/1프레임 혼용 → 1프레임으로 통일
4. **ReferenceError**: `isPitching` 미정의 오류 → 완전 제거

---

## 완료된 작업 (2025-10-31 오전)

### ✅ 리플레이 컨트롤 버그 수정

#### 1. 스페이스바 정지 기능 수정
- **문제**: 애니메이션 중간에 스페이스바로 일시정지하면 처음이나 끝으로 이동
- **원인**:
  - 리플레이 모드 전환 시 `replayTime`이 초기값(0)에 머물러 있음
  - 현재 `animationIndex`를 `replayTime`으로 동기화하지 않음
- **해결**: `PitchSimulator.tsx:171-176`
  - 리플레이 시작 시 현재 애니메이션 위치를 replayTime으로 동기화
  - `const currentTime = animationIndex / 30` 추가
  - 의존성 배열에 `animationIndex` 추가
- **결과**: 스페이스바 누르면 현재 위치에서 정확히 일시정지/재생
- **파일**: `src/scenarios/pitch/PitchSimulator.tsx:168-180, 256`

#### 2. 스트라이크 존 판정 로직 재확인
- **확인 결과**: 로직 정상 동작 확인
- **구현 내역**: `simulator.ts:144-156`
  - 스트라이크 존: 가로 0.44m, 높이 0.5~1.1m
  - 공 반지름 고려하여 접촉 판정 (경계 걸치면 스트라이크)
  - X축: `|x| ≤ 0.22 + ballRadius`
  - Y축: `0.5 - ballRadius ≤ y ≤ 1.1 + ballRadius`
- **판정 시점**: 홈플레이트 통과(z ≤ -18.44m) 시의 위치
- **파일**: `src/core/physics/simulator.ts:109-113, 124, 144-156`

---

## 완료된 작업 (2025-10-30)

### ✅ 릴리스 포인트 보정 + 회전축 수정 + 투수 모델

#### 1. 릴리스 포인트 자동 보정
- **문제**: 우완/좌완 투수가 릴리스 포인트(X≠0)에서 투구 시 공이 홈플레이트 중심을 향하지 않고 슬라이더처럼 빗나감
- **해결**: `src/core/physics/simulator.ts:53-75`
  - 릴리스 포인트에서 홈플레이트 중심(X=0, Z=-18.44)으로 향하는 자연스러운 각도 자동 계산
  - 사용자 입력 horizontal angle을 자연 각도에 더함 (미세 조정 가능)
  - `naturalHorizontalAngle = atan2(deltaX, -deltaZ)` 추가
- **파일**: `src/core/physics/simulator.ts`

#### 2. 스트라이크 존 판정 개선
- **문제**: 공의 중심만 체크하여 경계에 걸친 공이 볼 판정
- **해결**: 공 반지름 고려하여 **접촉 시 스트라이크** 판정
  - 스트라이크 존 범위를 `ballRadius`만큼 확장
  - 실제 야구 규칙 반영
- **파일**: `src/core/physics/simulator.ts:140-157`

#### 3. 회전축 정의 수정 (⚠️ Breaking Change)
- **문제**: X/Y/Z 회전축 설명이 완전히 잘못됨
- **수정 내용**:
  | 축 | 기존 (❌) | 수정 (✅) |
  |---|---|---|
  | **X축** | 낙차 증가/감소 | 백스핀/탑스핀 (떠오름/낙차) |
  | **Y축** | 백스핀/탑스핀 | 좌우 변화 (1루/3루 방향) |
  | **Z축** | 좌우 변화 | 총알회전 (궤적 변화 거의 없음) |
- **영향 범위**:
  - 파라미터 툴팁: `PitchInputPanel.tsx:21-32`
  - 투구 폼 예시: `PitchInputPanel.tsx:81-107`
  - 도움말 FAQ: `HelpModal.tsx:179-231`
  - 구종별 예시 수정 (포심, 커브, 슬라이더, 싱커 등)
- **⚠️ 주의**: 기존 저장된 실험 데이터는 회전축 의미 변경으로 궤적이 달라질 수 있음

#### 4. 투수 3D 모델 구현
- **신규 파일**: `src/scenarios/pitch/Pitcher3D.tsx`
- **기능**:
  - 릴리스 포인트 Y축에 따라 투구 폼 자동 판정 (오버핸드/사이드암/언더핸드)
  - 투구 애니메이션 (어깨 스윙, 팔꿈치 펴기, 손목 각도)
  - 릴리스 포인트 X좌표로 우완/좌완 자동 구분
  - 투구 전 손에 공 표시, 릴리스 후 숨김
  - 간단한 본 구조 (머리, 몸통, 다리, 팔)
- **통합**: `PitchSimulator.tsx:9, 322-333`
  - 비교 모드가 아닐 때만 표시
  - 애니메이션 진행률에 따라 동작 변화

#### 5. 도움말 파라미터 예시 추가
- **위치**: `HelpModal.tsx:217-231`
- **내용**: 구종별 파라미터 예시 (포심, 커브, 슬라이더, 체인지업, 싱커)

---

### ✅ Supabase Auth 및 비교 모드 구현 (2025-10-30 오전)

#### 1. Supabase 데이터베이스 구축
- **테이블 생성**:
  - `profiles`: 사용자 프로필 (username, role)
  - `experiments`: 실험 저장 (JSONB로 params + result)
  - `minigame_scores`: 미니게임 기록
- **RLS 정책**: 로그인 필수, 자신의 데이터만 접근
- **Auth 트리거**: 회원가입 시 프로필 자동 생성
- **파일**: `archive/데이터베이스_구축_계획.md`

#### 2. 로그인/회원가입 UI
- **컴포넌트**: `LoginPage.tsx`, `SignupPage.tsx`, `ProtectedRoute.tsx`
- **기능**:
  - 이메일/비밀번호 인증
  - username, role 입력
  - 로그인 가드 (미로그인 시 리디렉션)
  - LocalStorage → Supabase 자동 마이그레이션
- **라우팅**: `/login`, `/signup`, `/pitch`
- **파일**: `src/pages/`, `src/components/ProtectedRoute.tsx`

#### 3. 실험 저장/불러오기 Supabase 연동
- **API 레이어**: `src/lib/supabaseApi.ts`, `src/utils/supabaseExperiments.ts`
- **기능**:
  - 실험 목록 조회 (최신순 20개)
  - 실험 저장/삭제
  - LocalStorage 마이그레이션 (일회성)
- **이미 구현**: `RecentExperimentsPanel`이 Supabase 사용 중

#### 4. 비교 모드 구현
- **Context**: `ComparisonContext.tsx` (상태 관리)
- **UI**: `ComparisonPanel.tsx` (2개 실험 선택)
- **3D 렌더링**: 2개 궤적 동시 표시
  - 실험 A: 파란색 (`#4444ff`)
  - 실험 B: 빨간색 (`#ff4444`)
- **비교 표**: `ComparisonResultTable.tsx`
  - 6개 항목 비교 (판정, 비행시간, 최고높이, 수평변화, 수직낙차, 통과높이)
  - 차이값 표시 (오렌지색)
- **파일**: `src/contexts/ComparisonContext.tsx`, `src/core/ui/ComparisonPanel.tsx`, `src/core/ui/ComparisonResultTable.tsx`

#### 5. 버그 수정
- **finalVelocity 타입 오류**: Vector3 → 크기 계산으로 수정
- **horizontalMovement**: `horizontalBreak`로 수정

---

## 완료된 작업 (2025-10-28)

### ✅ 애니메이션 최적화 및 그래픽 설정 기능 구현 (최신)

#### 1. 애니메이션 부드러움 개선
- **문제**: setInterval 사용으로 공이 끊겨 보이는 현상 (20fps, 2포인트 건너뛰기)
- **해결**: requestAnimationFrame으로 전환
  - 브라우저 최적화 60fps 달성
  - 모든 궤적 포인트 표시 (부드러운 애니메이션)
  - 탭 비활성화 시 자동 중단 (배터리 절약)
- **파일**: `src/scenarios/pitch/PitchSimulator.tsx`

#### 2. 그래픽 설정 기능 구현
- **컴포넌트**: `GraphicsSettingsPanel.tsx`, `GraphicsContext.tsx`
- **기능**: 우측 패널 "그래픽" 탭 추가
- **프리셋 가이드라인**:
  - 저사양 (30fps, 안정적)
  - 중간 (45fps, 균형)
  - 고사양 (60fps, 최고 품질)
- **자유 조정 설정**:
  - 목표 FPS (30-60)
  - 픽셀 밀도/DPR (1.0-2.0x) - 가장 큰 성능 영향
  - 공 품질/폴리곤 수 (8-32)
  - 궤적 정밀도 (50-200점)
  - 시야각/FOV (40-75°)
  - 안티앨리어싱 (ON/OFF)
- **실시간 적용**:
  - Scene3D: DPR, FOV, 안티앨리어싱
  - Ball3D: 공 폴리곤 수 (동적 조정)
  - 애니메이션: 목표 FPS에 맞춘 프레임 간격
  - 물리 계산: trajectoryDt로 궤적 정밀도 제어
- **파일**: `src/contexts/GraphicsContext.tsx`, `src/core/ui/GraphicsSettingsPanel.tsx`, `src/core/renderer/Scene3D.tsx`, `src/scenarios/pitch/Ball3D.tsx`

#### 3. 디버그 패널 및 성능 모니터링
- **컴포넌트**: `DebugPanel.tsx`, `PerformanceMetrics` 타입
- **기능**: 우측 패널 "디버그" 탭 추가
- **측정 지표**:
  - 물리 계산 시간 (현재/평균/최대)
  - 렌더링 성능 (FPS, 렌더 시간, 프레임 카운트)
  - 전체 성능 (총 프레임 시간, 궤적 포인트 수)
  - 메모리 사용량 (사용/할당/제한)
  - 성능 평가 (우수/보통/저하)
- **콘솔 출력**: 브라우저 콘솔에 성능 지표 실시간 출력
  - 시뮬레이션 시작 시: 물리 계산 시간, 궤적 포인트, 결과 수치
  - 렌더링 중: 1초마다 FPS 및 렌더 시간 출력
- **파일**: `src/core/ui/DebugPanel.tsx`, `src/contexts/SimulationContext.tsx`, `src/core/renderer/Scene3D.tsx`

#### 4. 성능 분석 결과
- **저사양 설정 실측**:
  - 물리 계산: 1.6-4.7 ms (매우 빠름)
  - 애니메이션 중 렌더링: 9-15 FPS (목표 30fps 미달)
  - 애니메이션 완료 후: 16-17 FPS (개선)
- **병목 지점**: 궤적 라인 업데이트 + 공 이동 렌더링 (105ms/프레임)
- **결론**: 그래픽 설정만으론 부족, 렌더링 로직 최적화 필요 (보류)

#### 5. 버그 수정
- **finalVelocity 타입 오류**: Vector3 객체를 number로 잘못 처리 (콘솔 에러 발생)
- **horizontalMovement NaN**: 계산 오류 (미수정 상태)

---

## 완료된 작업 (2025-10-27)

### ✅ Phase 1 UI 구조 개선 완료

#### 1. 상단 네비게이션 바 구현
- **컴포넌트**: `TopNavigationBar.tsx`
- **기능**:
  - 뒤로가기 버튼 (시나리오 선택 화면으로 이동 예정)
  - 시나리오 이름 표시
  - 도움말 버튼 (모달 연동)
  - 사용자 메뉴 버튼 (향후 확장)
- **스타일**: 48px 높이, 고정 위치, 반응형

#### 2. 우측 패널 탭 구조 구현
- **컴포넌트**: `TabContainer.tsx`
- **탭 구성**: 4개 탭
  1. **파라미터**: 기존 PitchInputPanel 유지
  2. **결과**: CameraPresetButtons + ReplayControls + ResultPanel
  3. **최근 실험**: RecentExperimentsPanel (신규)
  4. **비교**: ComparisonPanel (플레이스홀더)
- **UI**: 탭 전환 애니메이션, 스크롤 영역 분리

#### 3. 도움말 모달 구현
- **컴포넌트**: `HelpModal.tsx`
- **탭 구성**: 3개 탭
  1. **시작하기**: 단계별 가이드 (파라미터 입력 → 실행 → 결과 확인)
  2. **키보드 단축키**:
     - 시뮬레이션: Space, R, Esc
     - 카메라: 1-5 (프리셋 전환)
     - 리플레이: ←→, [], ,.
  3. **FAQ**: 스트라이크 존, 회전축, 환경 변수, 비교 모드
- **기능**: 클릭으로 열기/닫기, 오버레이 배경

#### 4. 최근 실험 기능 구현 (LocalStorage)
- **컴포넌트**: `RecentExperimentsPanel.tsx`, `ExperimentDetailModal.tsx`
- **유틸리티**: `utils/recentExperiments.ts`
- **기능**:
  - 최대 10개 저장 (자동 정리)
  - 실험 저장 (이름 지정 모달)
  - 실험 불러오기 (파라미터 자동 입력) ✅ 버그 수정 완료
  - 실험 삭제 (개별/전체)
  - 실험 정보 표시 (속도, 회전, 스트라이크 판정)
  - **상세 보기 모달**: 파라미터 전체 + 결과 수치 상세 표시
    - 공 물성 (질량, 반지름, 항력계수, 양력계수)
    - 투구 조건 (속도, 각도, 회전 X/Y/Z, 릴리스 포인트)
    - 환경 변수 (중력, 온도, 기압, 습도)
    - 결과 (비행시간, 최고높이, 수평변화, 수직낙차, 최종속도 등)
- **저장 위치**: LocalStorage (키: `recentExperiments`)
- **데이터 구조**: `{ id, name, params, result, createdAt }`
- **버그 수정**: SimulationContext의 setParams 깊은 병합 로직 개선

---

## 완료된 작업 (2025-10-27 이전)

### ✅ 카메라 떨림 현상 해결 (최신)
- **문제**: 고정된 카메라 시점에서 화면이 떨리는 현상
- **원인**:
  - 매 프레임마다 lerp 적용으로 부동소수점 오차 누적
  - OrbitControls와 CameraController의 동시 제어 충돌
- **해결**:
  - 목표 위치 도달 시 lerp 중단 (거리 < 0.001m)
  - OrbitControls를 `free` 모드에서만 조건부 활성화
  - 고정 시점에서 lookAt 동기화
- **파일**: `src/core/renderer/CameraController.tsx`, `src/core/renderer/Scene3D.tsx`, `src/scenarios/pitch/PitchSimulator.tsx`

### ✅ 측면 시점 개선 (최신)
- 투수-포수 선과 완전히 수직인 시점 구현
- position: [15, 2.5, -9.22], target: [0, 1.5, -9.22]
- z 좌표를 정확히 중간 지점으로 통일
- **파일**: `src/core/renderer/CameraController.tsx`

### ✅ 회전축 설명 오류 (2025-10-30 해결됨)
- **문제**: X/Y/Z 회전축 설명이 완전히 잘못됨
- **해결**: 2025-10-30에 전면 수정 (Breaking Change)
  - X축: 백스핀/탑스핀
  - Y축: 좌우 변화
  - Z축: 총알회전
- **파일**: `src/scenarios/pitch/PitchInputPanel.tsx`

### ✅ 카메라 컨트롤 및 리플레이 기능 구현
- 카메라 프리셋 버튼 UI 구현 (포수 시점 / 측면 / 투수 시점)
- 리플레이 컨트롤 UI 구현 (Play/Pause, 속도 조절, 진행률 슬라이더)
- CameraController 컴포넌트로 카메라 로직 분리
- 시뮬레이션 일시정지/재개 기능 추가

### ✅ 릴리스 포인트 3D 좌표 구현
- `releaseHeight` 제거, `releasePoint: Vector3`로 통합
- X/Y/Z축 릴리스 포인트 입력 UI 구현
- 투구 폼별 예시 가이드 추가 (클릭하여 적용)
  - 오버핸드 우완/좌완
  - 사이드암 우완
  - 언더핸드 우완
  - 좌완 슬라이더
- 마그누스 효과가 극적으로 체감되도록 개선
- 우완/좌완 바깥쪽 릴리스로 실제 야구와 유사한 궤적 구현

### ✅ Phase 1-6: 기본 구현 완료 (2025-10-26)
- UI 모드 통합 (Simple/Advanced → 단일 모드)
- 파라미터 3단 구조 (공 물성 | 투구 조건 | 환경 변수)
- 중력 가변화 (환경 변수로 제어)
- 공기 밀도 자동 계산 (온도/기압/습도 → ρ)
- 에셋 단순화 (교육용 목적 명시)

### ✅ 프리셋 제거 및 직접 입력 UI 전환 (2025-10-26)
- 구종 프리셋 버튼 제거
- 13개 파라미터 직접 입력 UI 구현
- 파라미터 설명 툴팁 추가 (? 아이콘)
- 회전축 라벨 추가 (X/Y/Z)
- 구종별 입력 예시 가이드 버튼
- 스트라이크 존 통과 시점 실시간 판정

### ✅ 3D 렌더링 성능 최적화 (2025-10-26)
- Three.js geometry 폴리곤 수 감소
- 애니메이션 프레임레이트 조정 (50fps → 30fps)
- 그림자 품질 낮추기 (shadow-mapSize: 2048 → 1024)
- TrajectoryLine 포인트 간격 늘리기
- React.memo 적용 (Ball3D, TrajectoryLine)

### ✅ 해결된 이슈: 마그누스 효과 문제
**문제**: X/Z축 회전 시 수평 변화가 거의 체감되지 않음
**원인**: 릴리스 포인트가 정중앙이라 변화량이 밋밋하게 느껴짐 (물리 계산은 정상)
**해결**: 릴리스 포인트 3D 좌표 구현으로 해결 완료 (2025-10-27)

---

## 현재 상태

- **브랜치**: `dev` (현재 작업 중)
- **타입 체크**: ✅ 통과 (2025-10-31)
- **빌드**: 미확인
- **최근 작업**: 블렌더 투수 3D 모델 통합 및 애니메이션 시스템 구현 (2025-10-31 16:00~18:30)
- **주요 기능**:
  - ✅ 로그인/회원가입
  - ✅ 실험 저장/불러오기 (Supabase)
  - ✅ 비교 모드 (2개 궤적 동시 표시 + 비교 표)
  - ✅ 그래픽 설정 (FPS, DPR, 폴리곤, 시야각 등)
  - ✅ 디버그 패널 (성능 모니터링)
  - ✅ **블렌더 투수 3D 모델** (FBX 846KB, 119프레임 투구 애니메이션)
  - ✅ **트리거 기반 애니메이션 시스템** (48프레임 릴리스, 자동 복귀)
  - ✅ 릴리스 포인트 자동 보정 (홈플레이트 중심 지향)
  - ✅ 스트라이크 존 접촉 판정 (로직 재확인 완료)
  - ✅ 리플레이 정확한 일시정지/재생 (스페이스바)
- **데이터베이스**: Supabase (https://poxmraxgryatmjqjzqol.supabase.co)
  - ✅ 테이블: profiles, experiments, minigame_scores
  - ✅ RLS 정책 적용
  - ✅ Auth 트리거 설정
- **알려진 이슈**:
  - 렌더링 최적화 필요 (애니메이션 중 FPS 9-15, RTX 2050+ 환경에서는 정상)
- **⚠️ Breaking Change**: 회전축 의미 변경 (2025-10-30)
  - 기존 저장된 실험 데이터는 궤적이 달라질 수 있음
- **다음 작업**: FBX 모델 실제 테스트 및 Phase 3 (반응형 레이아웃, QR 코드)

## 개발 규칙

- **단위**: 미터(m), m/s, 도(°), rpm
- **좌표계**:
  - Z축 음수 = 홈플레이트 방향 (투수 → 포수)
  - X축 양수 = 1루 방향, X축 음수 = 3루 방향
  - Y축 양수 = 위쪽
- **회전축** (2025-10-30 수정):
  - **X축 회전**: 백스핀/탑스핀 (공이 떠오름/낙차)
  - **Y축 회전**: 좌우 변화 (1루/3루 방향, 슬라이더/커브)
  - **Z축 회전**: 총알회전 (진행 방향 축, 궤적 변화 거의 없음)
- **UI**: 단일 모드 (모드 토글 없음), **프리셋 없음** (직접 입력만)
- **파라미터**: 3단 구조 (공 물성 / 투구 조건 / 환경 변수)
- **중력**: 환경 변수로 조정 (고정값 아님)
- **에셋**: 단순화 우선 (< 300 폴리곤, 성능 최적화)
- **확장성**: 새 시나리오 추가 ~30분 (모듈식 구조)
- **성능**: 30fps 목표 (9세대 CPU 기준)

---

## 🚀 추후 예정 시나리오 (아이디어 보관)

### **책상 중력 게임 (Gravity Assist Puzzle)** 🌌
**컨셉**: 교실 책상을 우주 공간으로, 학생들을 행성으로 설정하여 우주선을 목표 지점까지 중력 도움(Gravity Assist)으로 도달시키는 협업 게임

**핵심 요소**:
- **물리**: 만유인력 (F = G·m₁·m₂/r²), 케플러 궤도, 중력 도움(NASA 실제 기술)
- **협업 필수**: 5-6명 참여 (중심 행성 1명 + 주변 행성 3-4명 + 발사자 1명)
- **백엔드 필수**: 실시간 위치 동기화 (Supabase Realtime), 궤적 계산, 리더보드
- **휴대폰 활용**:
  - 행성 역할: 위치 마킹, 질량 조정 (터치 슬라이더)
  - 발사자: 드래그로 발사 각도/속도 설정, 자이로스코프 활용
  - AR 옵션: 책상 위에 궤도 시각화

**게임 플레이**:
1. 학생들이 책상 주변에 배치 (각자 휴대폰으로 행성 역할)
2. 중심 학생이 축 행성 (큰 질량)
3. 발사자가 초기 속도/각도 설정
4. 서버에서 실시간 궤적 계산 → 모든 학생 화면에 동기화
5. 행성 학생들이 위치/질량 조정하여 우주선이 목표 도달하도록 협력
6. 성공 시 점수 획득 (연료 효율, 시간, 경로 등으로 평가)

**난이도**:
- 초급: 행성 1개, 단순 궤도 휘어짐
- 중급: 행성 2-3개, 스윙바이 기법
- 고급: 실제 우주 미션 재현 (보이저, 화성 탐사선 등)

**교육 가치**:
- 만유인력 법칙 체험
- 케플러 법칙 (타원/쌍곡선 궤도)
- 각운동량 보존
- 에너지 보존
- 실제 우주 탐사 기술 학습
- 고등학교 물리 II ~ 대학 물리 수준

**기술 스택**:
- BaseSimulator 재사용 (투구보다 물리 단순 - 순수 중력만)
- Three.js 3D 렌더링 (TrajectoryLine, Ball3D 재사용)
- Supabase Realtime (실시간 위치 동기화)
- 예상 개발 시간: 1-2일

**확장 가능성**:
- 라그랑주 점 도달 미션
- 호만 전이 궤도 (최소 에너지)
- 다중 우주선 협업 (우주 정거장 건설)
- 실제 천체 데이터 연동 (행성 질량, 거리)

**특징**:
- ✅ 교실 내 완벽 구현 가능
- ✅ 휴대폰 필수 활용 (위치, 터치, AR)
- ✅ 백엔드 필수 (실시간 동기화)
- ✅ 협업 게임성 높음
- ✅ 물리 교육 가치 높음
- ✅ 바이럴 가능성 (독창적 컨셉)
- ✅ BaseSimulator 재사용으로 빠른 구현

**참고**: 이 아이디어는 2025-10-30 브레인스토밍에서 도출됨. 투구 시뮬레이터 완성 후 차기 시나리오로 고려.

## 작업 관리 규칙

### 작업 목록 업데이트 정책
- 작업 완료 시 `archive/작업목록.md`를 업데이트할 것
- 토큰 효율을 위한 방법: Grep으로 수정 위치 찾기 → Read로 해당 부분만 읽기 → Edit로 정확히 수정
- 업데이트 주기: 3~4개 작업 완료 또는 작업 부문(Phase/섹션) 완료 시
- 매 작업마다 업데이트하지 말 것 (토큰 낭비 방지)

### 작업 결산 시 체크리스트 ✨ NEW
**세션 종료 전 반드시 확인**:

1. **필요한 내용 정리**:
   - [ ] 다음 세션에서 즉시 처리할 긴급 작업 정의
   - [ ] 작업 관련 파일 경로 명시
   - [ ] 예상되는 기술적 이슈 기록

2. **불필요한 내용 제거**:
   - [ ] 완료된 긴급 작업은 "완료된 작업" 섹션으로 이동
   - [ ] 해결된 이슈는 상태 업데이트 후 정리
   - [ ] 오래된 임시 메모/TODO 삭제

3. **커밋 준비**:
   - [ ] 작업 완료 후 커밋 메시지 초안 작성
   - [ ] 주요 변경사항 요약 (3~5줄)
   - [ ] 관련 이슈 번호 기록 (있을 경우)

4. **CLAUDE.md 업데이트**:
   - [ ] "현재 상태" 섹션 최신화
   - [ ] "마지막 업데이트" 날짜 갱신
   - [ ] 긴급 작업 우선순위 재정렬

---

**마지막 업데이트**: 2025-10-31 18:30 (블렌더 투수 모델 통합 완료)

---

## ⚡ 다음 세션 시작 시 확인 사항

1. ✅ **타입 체크 실행**: `npx tsc --noEmit` - 성공 (2025-10-31)
2. **🎬 블렌더 투수 모델 실제 테스트** (최우선):
   - 페이지 로딩 시 1프레임 대기 자세 확인
   - 시뮬레이션 시작 시 모션 재생 확인
   - 48프레임에서 공 생성 타이밍 확인
   - 119프레임 종료 후 1프레임 복귀 확인
   - 모션 재생 중 버튼 재클릭 시 강제 재시작 확인
   - 모델이 -Z 방향(홈플레이트)을 바라보는지 확인
   - 조명이 적절한지 확인
3. **회전축 동작 테스트** (중요! Breaking Change):
   - spinY=+5000 → 1루 방향 확인
   - spinY=-5000 → 3루 방향 확인
   - spinX=+2400 → 백스핀 떠오름 확인
   - 릴리스 포인트 X=+0.5, horizontal=0 → 홈플레이트 중심 통과 확인
4. ✅ **스트라이크 존 판정**: 로직 재확인 완료 - 정상 동작 (2025-10-31)
5. ✅ **스페이스바 정지 기능**: 버그 수정 완료 - 현재 위치에서 정확히 일시정지/재생 (2025-10-31)
6. **다음 Phase**: Phase 3 (반응형 레이아웃, QR 코드)

---
